<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ajouter Patient</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
  <h2>Ajouter un Patient</h2>
  <form id="patientForm">
    <div class="mb-3">
      <label class="form-label">Nom complet</label>
      <input type="text" class="form-control" name="name" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Date de naissance</label>
      <input type="date" class="form-control" name="dob" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Profession</label>
      <input type="text" class="form-control" name="profession">
    </div>
    <div class="mb-3">
      <label class="form-label">Sexe</label>
      <select class="form-select" name="sexe" required>
        <option value="M">M</option>
        <option value="F">F</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Téléphone</label>
      <input type="text" class="form-control" name="telephone">
    </div>
    <input type="hidden" name="user_id" value="1">
    <button type="submit" class="btn btn-primary">Ajouter</button>
  </form>

  <div id="result" class="mt-3"></div>

  <h3 class="mt-5">Liste des Patients</h3>
  <table class="table table-bordered mt-3" id="patientsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nom</th>
        <th>Date Naissance</th>
        <th>Profession</th>
        <th>Sexe</th>
        <th>Téléphone</th>
        <th>Code Patient</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
async function loadPatients() {
  const res = await fetch("/api/patients/list");
  const patients = await res.json();
  const tbody = document.querySelector("#patientsTable tbody");
  tbody.innerHTML = "";
  patients.forEach(p => {
    const row = `<tr>
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.dob ? new Date(p.dob).toLocaleDateString() : ""}</td>
      <td>${p.profession || ""}</td>
      <td>${p.sexe || ""}</td>
      <td>${p.telephone || ""}</td>
      <td>${p.code_patient}</td>
    </tr>`;
    tbody.innerHTML += row;
  });
}

document.getElementById("patientForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form).entries());

  const res = await fetch("/api/patients/add", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  const result = await res.json();
  if (res.ok) {
    document.getElementById("result").innerText = "Patient ajouté avec succès !";
    form.reset();
    loadPatients();
  } else {
    document.getElementById("result").innerText = "Erreur : " + (result.error || "Impossible d'ajouter");
  }
});

loadPatients();
</script>
</body>
</html>
