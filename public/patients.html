<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion des Patients</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<!-- Bandeau -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Omega Informatique - Gestion médicale</a>
  </div>
</nav>

<div class="container">
  <h2>Ajouter / Modifier un Patient</h2>
  <form id="patientForm">
    <input type="hidden" name="id" id="patientId">
    <div class="mb-3">
      <label class="form-label">Nom complet</label>
      <input type="text" class="form-control" name="name" id="name" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Date de naissance</label>
      <input type="date" class="form-control" name="dob" id="dob" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Profession</label>
      <input type="text" class="form-control" name="profession" id="profession">
    </div>
    <div class="mb-3">
      <label class="form-label">Sexe</label>
      <select class="form-select" name="sexe" id="sexe" required>
        <option value="M">M</option>
        <option value="F">F</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Téléphone</label>
      <input type="text" class="form-control" name="telephone" id="telephone">
    </div>
    <input type="hidden" name="user_id" value="1">
    <button type="submit" class="btn btn-primary" id="submitBtn">Ajouter</button>
    <button type="button" class="btn btn-secondary" id="cancelBtn" style="display:none;">Annuler</button>
  </form>

  <div id="result" class="mt-3"></div>

  <h3 class="mt-5">Liste des Patients</h3>
  <table class="table table-striped table-bordered mt-3">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Nom</th>
        <th>Date Naissance</th>
        <th>Profession</th>
        <th>Sexe</th>
        <th>Téléphone</th>
        <th>Code Patient</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="patientsTable"></tbody>
  </table>
</div>

<script>
async function loadPatients() {
  const res = await fetch("/api/patients/list");
  const patients = await res.json();
  const tbody = document.getElementById("patientsTable");
  tbody.innerHTML = "";
  patients.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.dob ? new Date(p.dob).toLocaleDateString() : ""}</td>
      <td>${p.profession || ""}</td>
      <td>${p.sexe || ""}</td>
      <td>${p.telephone || ""}</td>
      <td>${p.code_patient}</td>
      <td>
        <button class="btn btn-warning btn-sm" onclick="editPatient(${p.id})">Modifier</button>
        <button class="btn btn-danger btn-sm" onclick="deletePatient(${p.id})">Supprimer</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById("patientForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const id = document.getElementById("patientId").value;
  const data = {
    name: document.getElementById("name").value,
    dob: document.getElementById("dob").value,
    profession: document.getElementById("profession").value,
    sexe: document.getElementById("sexe").value,
    telephone: document.getElementById("telephone").value,
    user_id: 1
  };

  let url = "/api/patients/add";
  let method = "POST";
  if (id) {
    url = `/api/patients/update/${id}`;
    method = "PUT";
  }

  const res = await fetch(url, {
    method: method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  const result = await res.json();

  document.getElementById("result").innerText = result.message || "Opération réussie !";
  document.getElementById("patientForm").reset();
  document.getElementById("submitBtn").innerText = "Ajouter";
  document.getElementById("cancelBtn").style.display = "none";
  document.getElementById("patientId").value = "";
  loadPatients();
});

function editPatient(id) {
  fetch(`/api/patients/list`)
    .then(res => res.json())
    .then(patients => {
      const p = patients.find(x => x.id === id);
      if (p) {
        document.getElementById("patientId").value = p.id;
        document.getElementById("name").value = p.name;
        document.getElementById("dob").value = p.dob;
        document.getElementById("profession").value = p.profession;
        document.getElementById("sexe").value = p.sexe;
        document.getElementById("telephone").value = p.telephone;
        document.getElementById("submitBtn").innerText = "Modifier";
        document.getElementById("cancelBtn").style.display = "inline-block";
      }
    });
}

document.getElementById("cancelBtn").addEventListener("click", () => {
  document.getElementById("patientForm").reset();
  document.getElementById("submitBtn").innerText = "Ajouter";
  document.getElementById("cancelBtn").style.display = "none";
  document.getElementById("patientId").value = "";
});

async function deletePatient(id) {
  if (!confirm("Voulez-vous vraiment supprimer ce patient ?")) return;
  const res = await fetch(`/api/patients/delete/${id}`, { method: "DELETE" });
  const result = await res.json();
  document.getElementById("result").innerText = result.message;
  loadPatients();
}

// Chargement initial
loadPatients();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
