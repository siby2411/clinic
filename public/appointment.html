<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des Rendez-vous</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
  <h2 class="mb-4">Gestion des Rendez-vous</h2>

  <!-- Formulaire -->
  <form id="appointmentForm" class="card p-4 shadow-sm mb-4">
    <div class="row mb-3">
      <div class="col">
        <label class="form-label">Patient</label>
        <select class="form-select" name="patient_id" id="patientSelect" required></select>
      </div>
      <div class="col">
        <label class="form-label">Médecin</label>
        <select class="form-select" name="doctor_id" id="doctorSelect" required></select>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col">
        <label class="form-label">Date & Heure</label>
        <input type="datetime-local" class="form-control" name="date_time" required>
      </div>
      <div class="col">
        <label class="form-label">Statut</label>
        <select class="form-select" name="status">
          <option value="prévu">Prévu</option>
          <option value="confirmé">Confirmé</option>
          <option value="annulé">Annulé</option>
        </select>
      </div>
    </div>
    <button type="submit" class="btn btn-primary">Ajouter Rendez-vous</button>
  </form>

  <!-- Liste -->
  <h4>Liste des Rendez-vous</h4>
  <table class="table table-bordered" id="appointmentsTable">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Patient</th>
        <th>Médecin</th>
        <th>Date & Heure</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
async function loadPatients() {
  const res = await fetch("/api/patients/list");
  const patients = await res.json();
  const select = document.getElementById("patientSelect");
  select.innerHTML = patients.map(p => 
    `<option value="${p.id}">${p.code_patient} - ${p.name}</option>`
  ).join("");
}

async function loadDoctors() {
  const res = await fetch("/api/medecins/list");
  const medecins = await res.json();
  const select = document.getElementById("doctorSelect");
  select.innerHTML = medecins.map(m => 
    `<option value="${m.id}">${m.code_medecin} - ${m.nom} ${m.prenom}</option>`
  ).join("");
}

async function loadAppointments() {
  const res = await fetch("/api/appointments/list");
  const appointments = await res.json();
  const tbody = document.querySelector("#appointmentsTable tbody");
  tbody.innerHTML = appointments.map(a => `
    <tr>
      <td>${a.id}</td>
      <td>${a.code_patient}</td>
      <td>${a.code_medecin}</td>
      <td>${new Date(a.date_time).toLocaleString()}</td>
      <td>${a.status}</td>
      <td>
        <button class="btn btn-warning btn-sm" onclick="updateStatus(${a.id}, 'confirmé')">Confirmer</button>
        <button class="btn btn-danger btn-sm" onclick="deleteAppointment(${a.id})">Supprimer</button>
      </td>
    </tr>
  `).join("");
}

document.getElementById("appointmentForm").addEventListener("submit", async e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());
  await fetch("/api/appointments/add", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  e.target.reset();
  await loadAppointments();
});

async function updateStatus(id, status) {
  await fetch(`/api/appointments/update/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status })
  });
  loadAppointments();
}

async function deleteAppointment(id) {
  await fetch(`/api/appointments/delete/${id}`, { method: "DELETE" });
  loadAppointments();
}

loadPatients();
loadDoctors();
loadAppointments();
</script>
</body>
</html>
