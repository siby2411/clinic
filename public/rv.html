<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion des Rendez-vous</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

<div class="container">
  <h2 class="mb-4">Planification des Rendez-vous</h2>

  <form id="rendezVousForm" class="needs-validation" novalidate>
    <div class="mb-3">
      <label for="medecin_id" class="form-label">Médecin :</label>
      <select id="medecin_id" name="medecin_id" class="form-select" required></select>
      <div class="invalid-feedback">Sélectionnez un médecin.</div>
    </div>

    <div class="mb-3">
      <label for="patient_id" class="form-label">Patient :</label>
      <select id="patient_id" name="patient_id" class="form-select" required></select>
      <div class="invalid-feedback">Sélectionnez un patient.</div>
    </div>

    <div class="mb-3">
      <label for="date_rdv" class="form-label">Date :</label>
      <input type="date" id="date_rdv" name="date_rdv" class="form-control" required>
      <div class="invalid-feedback">Choisissez une date.</div>
    </div>

    <div class="mb-3">
      <label for="heure_rdv" class="form-label">Heure :</label>
      <input type="time" id="heure_rdv" name="heure_rdv" class="form-control" required>
      <div class="invalid-feedback">Choisissez une heure.</div>
    </div>

    <div class="mb-3">
      <label for="motif" class="form-label">Motif :</label>
      <input type="text" id="motif" name="motif" class="form-control" required>
      <div class="invalid-feedback">Indiquez le motif du rendez-vous.</div>
    </div>

    <button type="submit" class="btn btn-primary">Planifier le Rendez-vous</button>
  </form>

  <hr>
  <h3 class="mt-4">Rendez-vous programmés</h3>
  <table class="table table-bordered mt-2" id="rendezVousTable">
    <thead>
      <tr>
        <th>Médecin</th>
        <th>Patient</th>
        <th>Date</th>
        <th>Heure</th>
        <th>Motif</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
async function populateSelect(endpoint, selectId, textField="nom", valueField="id") {
    const res = await fetch(endpoint);
    const data = await res.json();
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">-- Sélectionner --</option>';
    data.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item[valueField];
        opt.textContent = item[textField];
        select.appendChild(opt);
    });
}

// Remplir les selects
populateSelect("/api/medecins", "medecin_id", "nom");
populateSelect("/api/patients", "patient_id", "name");

// Soumission formulaire
document.getElementById("rendezVousForm").addEventListener("submit", async e => {
    e.preventDefault();
    const form = e.target;
    if (!form.checkValidity()) {
        form.classList.add("was-validated");
        return;
    }
    const data = Object.fromEntries(new FormData(form));
    const res = await fetch("/api/rendez_vous", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });
    const result = await res.json();
    alert(result.message);
    if(res.ok !== false) {
        form.reset();
        loadRendezVous();
    }
});

// Charger les rendez-vous existants
async function loadRendezVous() {
    const res = await fetch("/api/rendez_vous");
    const data = await res.json();
    const tbody = document.querySelector("#rendezVousTable tbody");
    tbody.innerHTML = "";
    data.forEach(rdv => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${rdv.medecin_nom}</td>
            <td>${rdv.patient_nom}</td>
            <td>${rdv.date_rdv}</td>
            <td>${rdv.heure_rdv}</td>
            <td>${rdv.motif}</td>
        `;
        tbody.appendChild(tr);
    });
}

// Initial load
loadRendezVous();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
